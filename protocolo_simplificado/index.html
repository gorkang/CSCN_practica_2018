<!DOCTYPE html>
<html style="height:90%;">

<head>
  <meta charset='UTF-8'>
  <meta name="robots" content="noindex">
  <title>Experimentos CSCN</title>
</head>

<body style="height:100%;text-align:center;">
  <script>
    function partial_shuffle(list, index_start, index_end) {
      if (index_end < list.length && index_start >= 0) {
        var currentIndex = index_end;
        var temporaryValue;
        var randomIndex;
        while (currentIndex !== index_start) {
          randomIndex = Math.floor(Math.random() * currentIndex) + index_start;
          temporaryValue = list[currentIndex];
          list[currentIndex] = list[randomIndex];
          list[randomIndex] = temporaryValue;
          currentIndex -= 1;
        }
      } else {
        throw "Index out of range."
      }
      return (list);
    }

    function shuffle(list) {
      if (list.length != 0) {
        return partial_shuffle(list, 0, list.length - 1);
      } else {
        return list;
      }
    }
    var experiments_random = shuffle([]);
    var experiments = '';
    experiments = experiments.split(',');
    experiments.reverse();

    var subject_number = 0;
    var currentExperiment = "";
    loaded_once = false;

    function go_fullscreen(event) {
      tries = 4;
      while (tries > 0) {
        if (tries == 4) {
          try {
            document.getElementById("iframe").mozRequestFullScreen();
            tries = 0;
          } catch (error) {
            console.log(error);
          }
        } else if (tries == 3) {
          try {
            document.getElementById("iframe").webkitRequestFullScreen();
            tries = 0;
          } catch (error) {
            console.log(error);
          }
        } else if (tries == 2) {
          try {
            document.getElementById("iframe").msRequestFullscreen();
            tries = 0;
          } catch (error) {
            console.log(error);
          }
        } else if (tries == 1) {
          try {
            document.getElementById("iframe").requestFullscreen();
            tries = 0;
          } catch (error) {
            console.log(error);
          }
        }
        tries -= 1;
      }
      next(event);
    }

    function local_save(csv, name) {
      var blobToSave = new Blob([csv], {
        type: 'text/plain'
      });
      var blobURL = "";
      if (typeof window.webkitURL !== 'undefined') {
        blobURL = window.webkitURL.createObjectURL(blobToSave);
      } else {
        blobURL = window.URL.createObjectURL(blobToSave);
      }
      var link = document.createElement('a');
      link.href = blobURL;
      link.setAttribute('download', name + ".csv");
      document.body.appendChild(link);
      link.click();
    }

    function next(event) {
      if (!loaded_once && experiments.length > 0) {
        loaded_once = true;
        currentExperiment = experiments.pop();
        if (localStorage.experiments_completed) {
          completedExperiments = localStorage.experiments_completed.split(',');
          while (completedExperiments.includes(currentExperiment)) {
            currentExperiment = experiments.pop();
          }
        }
        window.addEventListener('message', function(message) {
          if (experiments.length > 0) {
            localStorage.setItem(currentExperiment, message.data.csv);
            localStorage.setItem(currentExperiment + "_filename", message.data.name);
            if (localStorage.experiments_completed) {
              localStorage.setItem("experiments_completed", localStorage.experiments_completed + "," + currentExperiment);
            } else {
              localStorage.setItem("experiments_completed", currentExperiment);
            }
            currentExperiment = experiments.pop();
            document.getElementById('iframe').src = "./" + currentExperiment + "/index.html";
          } else {
            local_save(message.data.csv, subject_number + "_" + currentExperiment + "_" + Date().split(' ').join('_'));
            completedExperiments = localStorage.experiments_completed.split(',');
            for (var experiment_index in completedExperiments) {
              local_save(localStorage[completedExperiments[experiment_index]], subject_number + "_" + completedExperiments[experiment_index] + "_" + Date().split(' ').join('_'));
            }
            localStorage.clear();
          }
        });
        document.getElementById('iframe').src = "./" + currentExperiment + "/index.html";
      }
    }
  </script>
  <input type="button" onclick="go_fullscreen(event)" style="margin-top:25%;" value="Comenzar"></input>
  <iframe id="iframe" allowfullscreen=true src="" style="border:none;background:white;" width="100%" height="100%" sandbox="allow-scripts allow-same-origin allow-forms">
  </body>
</html>
