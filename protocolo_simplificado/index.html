<!DOCTYPE html>
<html style="height:90%;">

<head>
  <meta charset='UTF-8'>
  <meta name="robots" content="noindex">
  <title>Experimentos CSCN</title>
</head>

<body style="height:100%;text-align:center;">
  <script>
    function partial_shuffle(list, index_start, index_end) {
      if (index_end < list.length && index_start >= 0) {
        var currentIndex = index_end;
        var temporaryValue;
        var randomIndex;
        while (currentIndex !== index_start) {
          randomIndex = Math.floor(Math.random() * currentIndex) + index_start;
          currentIndex -= 1;
          temporaryValue = list[currentIndex];
          list[currentIndex] = list[randomIndex];
          list[randomIndex] = temporaryValue;
        }
      } else {
        throw "Index out of range."
      }
      return (list);
    }

    function shuffle(list) {
      return partial_shuffle(list, 0, list.length - 1);
    }

    var experiments_random = [];
    var experiments = "informacion_sociodemografica_simple,bret,wais_working_memory";
    experiments = experiments.split(',');
    experiments.reverse();

    var currentExperiment = '';
    var user_id = 0;
    var loaded_once = false;

    function start_experiment(event) {
      if (currentExperiment == '') {
        currentExperiment = experiments.pop();
      }
      if (document.getElementById('user_id').reportValidity() && !loaded_once) {
        user_id = document.getElementById('user_id').value;
        loaded_once = true;
        go_fullscreen(event);
        show_experiments(event);
        document.getElementById('user_id').disabled = true;
      } else if (loaded_once) {
        go_fullscreen(event);
      }
    }

    function start_and_skip_last_experiment(event) {
      skip_to_last();
      if (experiments.length > 0) {
        currentExperiment = experiments.pop();
      }
      start_experiment(event);
    }

    function start_and_skip_to_last_experiment(event) {
      skip_to_last();
      start_experiment(event);
    }

    function redo_experiment(event) {
      if (confirm("Â¿Esta seguro de que quiere volver a usar este id?")) {
        user_backup_id = document.getElementById('user_id').value
        backup = localStorage[user_backup_id];
        delete(localStorage[user_backup_id]);
        backup_index = 2;
        while(localStorage[user_backup_id +  "_" backup_index]){
          backup_index += 1;
        }
        localStorage.setItem(user_backup_id +  "_" backup_index, backup);
        start_experiment(event);
      }
    }

    function go_fullscreen(event) {
      tries = 4;
      while (tries > 0) {
        if (tries == 4) {
          try {
            document.getElementById("iframe").mozRequestFullScreen();
            tries = 0;
          } catch (error) {
            console.log(error);
          }
        } else if (tries == 3) {
          try {
            document.getElementById("iframe").webkitRequestFullScreen();
            tries = 0;
          } catch (error) {
            console.log(error);
          }
        } else if (tries == 2) {
          try {
            document.getElementById("iframe").msRequestFullscreen();
            tries = 0;
          } catch (error) {
            console.log(error);
          }
        } else if (tries == 1) {
          try {
            document.getElementById("iframe").requestFullscreen();
            tries = 0;
          } catch (error) {
            console.log(error);
          }
        }
        tries -= 1;
      }
    }

    function local_save(csv, name) {
      var blobToSave = new Blob([csv], {
        type: 'text/plain'
      });
      var blobURL = "";
      if (typeof window.webkitURL !== 'undefined') {
        blobURL = window.webkitURL.createObjectURL(blobToSave);
      } else {
        blobURL = window.URL.createObjectURL(blobToSave);
      }
      var link = document.createElement('a');
      link.href = blobURL;
      link.setAttribute('download', name + ".csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function local_storage_save(csv, experiment) {
      if (localStorage[user_id]) {
        user_data = JSON.parse(localStorage[user_id])
        user_data.completed_experiments += "," + experiment;
        user_data[experiment] = csv;
        localStorage[user_id] = JSON.stringify(user_data);
      } else {
        user_data = {
          completed_experiments: experiment
        }
        user_data[experiment] = csv;
        localStorage.setItem(user_id, JSON.stringify(user_data));
      }
    }

    function check_local_storage(experiment) {
      if (localStorage[user_id]) {
        user_data = JSON.parse(localStorage[user_id]);
        if (user_data.completed_experiments.split(',').includes(experiment) || experiment == '') {
          return true;
        } else {
          return false;
        }
      } else if (experiment == '') {
        return true;
      } else {
        return false;
      }
    }

    function skip_to_last() {
      while (check_local_storage(currentExperiment)) {
        currentExperiment = experiments.pop();
      }
    }

    function check_id_status(event) {
      user_id_to_check = event.target.value;
      if (localStorage[user_id_to_check]) {
        document.getElementById("start").hidden = true;
        document.getElementById("start_and_skip_to_last").hidden = false;
        document.getElementById("start_and_skip_last").hidden = false;
        document.getElementById("redo").hidden = false;
      } else {
        document.getElementById("start").hidden = false;
        document.getElementById("start_and_skip_to_last").hidden = true;
        document.getElementById("start_and_skip_last").hidden = true;
        document.getElementById("redo").hidden = true;
      }
    }

    function show_experiments(event) {
      window.addEventListener('message', function(message) {
        local_storage_save(message.data.csv, currentExperiment);
        if (experiments.length > 0) {
          currentExperiment = experiments.pop();
          document.getElementById('iframe').src = "./" + currentExperiment + "/index.html" + "?user_id=" + user_id;
        }
      });
      document.getElementById('iframe').src = "./" + currentExperiment + "/index.html" + "?user_id=" + user_id;
    }
  </script>
  <form>
    <input type="number" oninput="check_id_status(event)" required id="user_id" min="0" step="1" style="margin-top:25%;"></input>
    <input id="start" type="button" onclick="start_experiment(event)" style="margin-top:25%;" value="Comenzar"></input>
    <input id="start_and_skip_to_last" type="button" onclick="start_and_skip_to_last_experiment(event)" style="margin-top:25%;" value="Comenzar a partir del ultimo experimento completado" hidden></input>
    <input id="start_and_skip_last" type="button" onclick="start_and_skip_last_experiment(event)" style="margin-top:25%;" value="Comenzar despues del ultimo experimento completado" hidden></input>
    <input id="redo" type="button" onclick="redo_experiment(event)" style="margin-top:25%;" value="Borrar datos y comenzar" hidden></input>
  </form>
  <iframe id="iframe" allowfullscreen=true src="" style="border:none;background:white;" width="100%" height="100%" sandbox="allow-scripts allow-same-origin allow-forms">
  </body>
</html>
